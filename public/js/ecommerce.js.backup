// E-Commerce Management Functions for Gigies Dashboard

// Get API base path from app.js
const API_BASE = window.API_BASE || '';

// ============================================
// PRODUCTS MANAGEMENT
// ============================================

// Load Products
async function loadProducts() {
  try {
    const response = await fetch(`${API_BASE}/api/ecommerce/products`);
    const data = await response.json();
    
    const productsList = document.getElementById('productsList');
    
    if (!data.success || data.products.length === 0) {
      productsList.innerHTML = '<div class="empty-state">No products found. Add your first product!</div>';
      return;
    }
    
    productsList.innerHTML = data.products.map(product => `
      <div class="product-card">
        ${product.image_url ? `<img src="${product.image_url}" alt="${product.name}" class="product-image">` : ''}
        <div class="product-info">
          <h3>${product.name}</h3>
          <p class="product-category">${product.category_name || 'Uncategorized'}</p>
          <p class="product-description">${product.description || ''}</p>
          <div class="product-meta">
            <span class="product-price">Rs. ${parseFloat(product.price).toLocaleString()}</span>
            <span class="product-stock">Stock: ${product.stock_quantity}</span>
            <span class="product-status status-${product.status}">${product.status}</span>
          </div>
        </div>
        <div class="product-actions">
          <button onclick="editProduct(${product.id})" class="btn-icon" title="Edit">‚úèÔ∏è</button>
          <button onclick="deleteProduct(${product.id})" class="btn-icon" title="Delete">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
    
  } catch (error) {
    console.error('Error loading products:', error);
    showToast('Error loading products', 'error');
  }
}

// Show Add Product Modal
function showAddProductModal() {
  document.getElementById('productId').value = '';
  document.getElementById('productName').value = '';
  document.getElementById('productDescription').value = '';
  document.getElementById('productPrice').value = '';
  document.getElementById('productStock').value = '';
  document.getElementById('productImage').value = '';
  document.getElementById('productStatus').value = 'active';
  document.getElementById('productCategory').value = '';
  document.getElementById('productModalTitle').textContent = 'Add Product';
  
  // Load categories for dropdown
  loadCategoriesDropdown();
  
  document.getElementById('productModal').style.display = 'flex';
}

// Load Categories for Dropdown
async function loadCategoriesDropdown() {
  try {
    const response = await fetch(`${API_BASE}/api/ecommerce/categories`);
    const data = await response.json();
    
    const select = document.getElementById('productCategory');
    select.innerHTML = '<option value="">Select Category</option>' + 
      data.categories.map(cat => `<option value="${cat.id}">${cat.icon || ''} ${cat.name}</option>`).join('');
      
  } catch (error) {
    console.error('Error loading categories:', error);
  }
}

// Edit Product
async function editProduct(id) {
  try {
    const response = await fetch(`${API_BASE}/api/ecommerce/products/${id}`);
    const data = await response.json();
    
    if (!data.success) {
      showToast('Product not found', 'error');
      return;
    }
    
    const product = data.product;
    document.getElementById('productId').value = product.id;
    document.getElementById('productName').value = product.name;
    document.getElementById('productDescription').value = product.description || '';
    document.getElementById('productPrice').value = product.price;
    document.getElementById('productStock').value = product.stock_quantity;
    document.getElementById('productImage').value = product.image_url || '';
    document.getElementById('productStatus').value = product.status;
    document.getElementById('productCategory').value = product.category_id || '';
    document.getElementById('productModalTitle').textContent = 'Edit Product';
    
    loadCategoriesDropdown();
    document.getElementById('productModal').style.display = 'flex';
    
  } catch (error) {
    console.error('Error loading product:', error);
    showToast('Error loading product', 'error');
  }
}

// Save Product
async function saveProduct() {
  const id = document.getElementById('productId').value;
  const productData = {
    name: document.getElementById('productName').value,
    description: document.getElementById('productDescription').value,
    price: parseFloat(document.getElementById('productPrice').value),
    stock_quantity: parseInt(document.getElementById('productStock').value),
    image_url: document.getElementById('productImage').value,
    status: document.getElementById('productStatus').value,
    category_id: document.getElementById('productCategory').value || null
  };
  
  if (!productData.name || !productData.price || productData.stock_quantity === undefined) {
    showToast('Please fill in all required fields', 'error');
    return;
  }
  
  try {
    const url = id ? `/api/ecommerce/products/${id}` : '/api/ecommerce/products';
    const method = id ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(productData)
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast(id ? 'Product updated!' : 'Product added!', 'success');
      closeProductModal();
      loadProducts();
    } else {
      showToast(data.message || 'Error saving product', 'error');
    }
    
  } catch (error) {
    console.error('Error saving product:', error);
    showToast('Error saving product', 'error');
  }
}

// Delete Product
async function deleteProduct(id) {
  if (!confirm('Are you sure you want to delete this product?')) return;
  
  try {
    const response = await fetch(`${API_BASE}/api/ecommerce/products/${id}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Product deleted', 'success');
      loadProducts();
    } else {
      showToast(data.message || 'Error deleting product', 'error');
    }
    
  } catch (error) {
    console.error('Error deleting product:', error);
    showToast('Error deleting product', 'error');
  }
}

// Close Product Modal
function closeProductModal() {
  document.getElementById('productModal').style.display = 'none';
}

// ============================================
// CATEGORIES MANAGEMENT
// ============================================

// Load Categories
async function loadCategories() {
  try {
    const response = await fetch(`${API_BASE}/api/ecommerce/categories`);
    const data = await response.json();
    
    const categoriesList = document.getElementById('categoriesList');
    
    if (!data.success || data.categories.length === 0) {
      categoriesList.innerHTML = '<div class="empty-state">No categories found. Add your first category!</div>';
      return;
    }
    
    categoriesList.innerHTML = data.categories.map(category => `
      <div class="category-card">
        <div class="category-icon">${category.icon || 'üìÇ'}</div>
        <div class="category-info">
          <h3>${category.name}</h3>
          <p>${category.description || ''}</p>
          <span class="category-count">${category.product_count || 0} products</span>
        </div>
        <div class="category-actions">
          <button onclick="editCategory(${category.id})" class="btn-icon" title="Edit">‚úèÔ∏è</button>
          <button onclick="deleteCategory(${category.id})" class="btn-icon" title="Delete">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
    
  } catch (error) {
    console.error('Error loading categories:', error);
    showToast('Error loading categories', 'error');
  }
}

// Show Add Category Modal
function showAddCategoryModal() {
  document.getElementById('categoryId').value = '';
  document.getElementById('categoryName').value = '';
  document.getElementById('categoryDescription').value = '';
  document.getElementById('categoryIcon').value = '';
  document.getElementById('categorySortOrder').value = '0';
  document.getElementById('categoryModalTitle').textContent = 'Add Category';
  document.getElementById('categoryModal').style.display = 'flex';
}

// Edit Category
async function editCategory(id) {
  try {
    const response = await fetch(`${API_BASE}/api/ecommerce/categories/${id}`);
    const data = await response.json();
    
    if (!data.success) {
      showToast('Category not found', 'error');
      return;
    }
    
    const category = data.category;
    document.getElementById('categoryId').value = category.id;
    document.getElementById('categoryName').value = category.name;
    document.getElementById('categoryDescription').value = category.description || '';
    document.getElementById('categoryIcon').value = category.icon || '';
    document.getElementById('categorySortOrder').value = category.sort_order || 0;
    document.getElementById('categoryModalTitle').textContent = 'Edit Category';
    document.getElementById('categoryModal').style.display = 'flex';
    
  } catch (error) {
    console.error('Error loading category:', error);
    showToast('Error loading category', 'error');
  }
}

// Save Category
async function saveCategory() {
  const id = document.getElementById('categoryId').value;
  const categoryData = {
    name: document.getElementById('categoryName').value,
    description: document.getElementById('categoryDescription').value,
    icon: document.getElementById('categoryIcon').value,
    sort_order: parseInt(document.getElementById('categorySortOrder').value) || 0
  };
  
  if (!categoryData.name) {
    showToast('Please enter category name', 'error');
    return;
  }
  
  try {
    const url = id ? `/api/ecommerce/categories/${id}` : '/api/ecommerce/categories';
    const method = id ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(categoryData)
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast(id ? 'Category updated!' : 'Category added!', 'success');
      closeCategoryModal();
      loadCategories();
    } else {
      showToast(data.message || 'Error saving category', 'error');
    }
    
  } catch (error) {
    console.error('Error saving category:', error);
    showToast('Error saving category', 'error');
  }
}

// Delete Category
async function deleteCategory(id) {
  if (!confirm('Are you sure you want to delete this category?')) return;
  
  try {
    const response = await fetch(`${API_BASE}/api/ecommerce/categories/${id}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Category deleted', 'success');
      loadCategories();
    } else {
      showToast(data.message || 'Error deleting category', 'error');
    }
    
  } catch (error) {
    console.error('Error deleting category:', error);
    showToast('Error deleting category', 'error');
  }
}

// Close Category Modal
function closeCategoryModal() {
  document.getElementById('categoryModal').style.display = 'none';
}

// ============================================
// ORDERS MANAGEMENT
// ============================================

// Load Orders
async function loadOrders() {
  try {
    const response = await fetch(`${API_BASE}/api/ecommerce/orders`);
    const data = await response.json();
    
    const ordersList = document.getElementById('ordersList');
    
    if (!data.success || data.orders.length === 0) {
      ordersList.innerHTML = '<div class="empty-state">No orders yet. Orders will appear here when customers place them via WhatsApp.</div>';
      return;
    }
    
    ordersList.innerHTML = data.orders.map(order => `
      <div class="order-card">
        <div class="order-header">
          <h3>Order #${order.order_number}</h3>
          <span class="order-status status-${order.status}">${order.status}</span>
        </div>
        <div class="order-info">
          <p><strong>Customer:</strong> ${order.customer_name || 'N/A'} (${order.phone_number})</p>
          <p><strong>Address:</strong> ${order.delivery_address || 'N/A'}, ${order.city || ''}</p>
          <p><strong>Total:</strong> Rs. ${parseFloat(order.total_amount).toLocaleString()}</p>
          <p><strong>Payment:</strong> ${order.payment_method || 'N/A'} (${order.payment_status})</p>
          <p><strong>Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
          ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
        </div>
        <div class="order-actions">
          <select onchange="updateOrderStatus(${order.id}, this.value)" class="order-status-select">
            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
          </select>
        </div>
      </div>
    `).join('');
    
  } catch (error) {
    console.error('Error loading orders:', error);
    showToast('Error loading orders', 'error');
  }
}

// Update Order Status
async function updateOrderStatus(orderId, newStatus) {
  try {
    const response = await fetch(`${API_BASE}/api/ecommerce/orders/${orderId}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Order status updated', 'success');
    } else {
      showToast(data.message || 'Error updating order', 'error');
      loadOrders(); // Reload to reset dropdown
    }
    
  } catch (error) {
    console.error('Error updating order:', error);
    showToast('Error updating order', 'error');
  }
}

// ============================================
// STORE SETTINGS MANAGEMENT
// ============================================

// Load Store Settings
async function loadStoreSettings() {
  try {
    const response = await fetch(`${API_BASE}/api/ecommerce/settings`);
    const data = await response.json();
    
    if (data.success && data.settings) {
      const settings = data.settings;
      document.getElementById('storeName').value = settings.store_name || '';
      document.getElementById('welcomeMessage').value = settings.welcome_message || '';
      document.getElementById('businessHours').value = settings.business_hours || '';
      document.getElementById('deliveryFee').value = settings.delivery_fee || '';
      document.getElementById('freeDeliveryAbove').value = settings.free_delivery_above || '';
      document.getElementById('paymentMethods').value = settings.payment_methods || '';
      document.getElementById('deliveryAreas').value = settings.delivery_areas || '';
    }
    
  } catch (error) {
    console.error('Error loading store settings:', error);
    showToast('Error loading settings', 'error');
  }
}

// Save Store Settings
async function saveStoreSettings() {
  const settings = {
    store_name: document.getElementById('storeName').value,
    welcome_message: document.getElementById('welcomeMessage').value,
    business_hours: document.getElementById('businessHours').value,
    delivery_fee: document.getElementById('deliveryFee').value,
    free_delivery_above: document.getElementById('freeDeliveryAbove').value,
    payment_methods: document.getElementById('paymentMethods').value,
    delivery_areas: document.getElementById('deliveryAreas').value
  };
  
  try {
    const response = await fetch(`${API_BASE}/api/ecommerce/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(settings)
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Store settings saved!', 'success');
    } else {
      showToast(data.message || 'Error saving settings', 'error');
    }
    
  } catch (error) {
    console.error('Error saving settings:', error);
    showToast('Error saving settings', 'error');
  }
}

// ============================================
// TAB INITIALIZATION
// ============================================

// This function is called by app.js when e-commerce tabs are activated
window.loadEcommerceTab = function(tabName) {
  if (tabName === 'products') {
    loadProducts();
  } else if (tabName === 'categories') {
    loadCategories();
  } else if (tabName === 'orders') {
    loadOrders();
  } else if (tabName === 'store-settings') {
    loadStoreSettings();
  }
};
